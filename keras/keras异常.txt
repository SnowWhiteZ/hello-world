
load一个bert微调后的模型时
model = load_model('/home/gswyhq/hello-world/bert/model.h5')
报错：
ImportError: cannot import name 'TokenEmbedding'
问题分析
当我们自定义loss或者layer时，如果直接进行训练后模型文件加载，将会出现Value error 或layer 不存在等问题。
解决方案：
在Keras中，如果存在自定义layer或者loss，需要在load_model()中以字典形式指定layer或loss。如：

from keras_bert.layers.embedding import TokenEmbedding
from keras_pos_embd.pos_embd import PositionEmbedding
from keras_layer_normalization.layer_normalization import LayerNormalization
from keras_multi_head.multi_head_attention import MultiHeadAttention
from keras_position_wise_feed_forward.feed_forward import FeedForward
from keras_bert.bert import gelu_tensorflow

model = load_model('/home/gswyhq/hello-world/bert/model.h5', custom_objects={'TokenEmbedding':TokenEmbedding,
                                                                             'PositionEmbedding': PositionEmbedding,
                                                                             'LayerNormalization': LayerNormalization,
                                                                             'MultiHeadAttention': MultiHeadAttention,
                                                                             'FeedForward': FeedForward,
                                                                             'gelu_tensorflow': gelu_tensorflow})

ValueError: Unknown layer: Attention
#这里需要注意两点，
#1、是'Attention',这里对应了model.summary()打印的attention_1层的type
#2、AttentionLayer是class Attention实例化出来的对象

# 梯度消失与梯度爆炸、Loss为Nan的原因
1.梯度爆炸。梯度变得非常大，使得学习过程难以继续。
2.不当的损失函数。
3.不当的输入。if np.isnan(data).any(): continue
4.池化层中步长比卷积核的尺寸大。

在导入_obtain_input_shape时
from keras.applications.imagenet_utils import _obtain_input_shape

出现错误如下：
ImportError: cannot import name '_obtain_input_shape'
原因是在keras 2.2.2中，keras.applications.imagenet_utils模块不再有_obtain_input_shape方法。解决方法：
将导入语句修改如下
from keras_applications.imagenet_utils import _obtain_input_shape

keras可视化时报错：
  File "/usr/local/lib/python3.5/dist-packages/pydot.py", line 136, in call_graphviz
    **kwargs
  File "/usr/lib/python3.5/subprocess.py", line 947, in __init__
    restore_signals, start_new_session)
  File "/usr/lib/python3.5/subprocess.py", line 1551, in _execute_child
    raise child_exception_type(errno_num, err_msg)
FileNotFoundError: [Errno 2] No such file or directory: 'dot'

解决方法：
# apt-get install graphviz
# dot -V
dot - graphviz version 2.38.0 (20140413.2041)

利用model.fit_generator训练，并且可视化训练过程时，报错：
  File "/usr/local/lib/python3.5/dist-packages/keras/callbacks.py", line 912, in on_epoch_end
    raise ValueError("If printing histograms, validation_data must be "
ValueError: If printing histograms, validation_data must be provided, and cannot be a generator.

解决方法：
直接把histogram_freq设置为0即可，histogram_freq，按照何等频率（epoch）来计算直方图，0为不计算
tbCallBack = TensorBoard(log_dir=TENSORBOARD_PATH, histogram_freq=0,  
                  write_graph=True, write_images=True)

